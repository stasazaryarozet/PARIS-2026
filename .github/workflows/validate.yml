name: Validate Build

# Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ÑÑ Ð½Ð°:
# - Pull Requests Ð² main Ð¸Ð»Ð¸ develop
# - Push Ð² main Ð¸Ð»Ð¸ develop

on:
  pull_request:
    branches:
      - main
      - develop
  push:
    branches:
      - main
      - develop

jobs:
  validate:
    name: Validate content.js generation
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run build.py
        run: |
          echo "ðŸ”¨ Running build.py..."
          python3 build.py

      - name: Run tests
        run: |
          echo "ðŸ§ª Running validation tests..."
          python3 test_build.py

      - name: Check for uncommitted changes
        run: |
          if git diff --exit-code content.js; then
            echo "âœ… content.js is in sync with WEBSITE_CONTENT.md"
          else
            echo "âŒ content.js is out of sync!"
            echo "Please run 'python3 build.py' and commit the changes"
            exit 1
          fi

      - name: Validate commit messages
        if: github.event_name == 'pull_request'
        run: |
          echo "ðŸ“ Validating commit messages..."
          # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð²ÑÐµ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ñ‹ Ð² PR
          COMMITS=$(gh pr view ${{ github.event.pull_request.number }} --json commits --jq '.commits[].messageHeadline')
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ Conventional Commits
          echo "$COMMITS" | while read -r commit; do
            if [[ $commit =~ ^(feat|fix|docs|style|refactor|test|chore|build|ci|perf|revert)(\(.+\))?: ]]; then
              echo "âœ… Valid: $commit"
            else
              echo "âŒ Invalid format: $commit"
              echo "Expected: type(scope): subject"
              exit 1
            fi
          done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-info:
    name: Build Information
    runs-on: ubuntu-latest
    if: github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð²ÑÑŽ Ð¸ÑÑ‚Ð¾Ñ€Ð¸ÑŽ Ð´Ð»Ñ Ñ‚ÐµÐ³Ð¾Ð²

      - name: Get version info
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v2.0.0")
          CODENAME=$(grep '^version:' WEBSITE_CONTENT.md | sed 's/version: "\(.*\)"/\1/')
          
          echo "## ðŸ“Š Build Information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Last Tag:** $LAST_TAG" >> $GITHUB_STEP_SUMMARY
          echo "- **Codename:** $CODENAME" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸš€ Deploy to GitHub Pages will start automatically" >> $GITHUB_STEP_SUMMARY

